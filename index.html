<script>
let currentUser = null;
let userData = [];

fetch("data.json")
  .then(response => response.json())
  .then(data => userData = data);

function showLoading(id) {
  document.getElementById(id).style.display = "inline-block";
  return new Promise(res => setTimeout(res, 2000));
}

async function validateLogin() {
  document.getElementById("errorMsg").innerText = "";
  await showLoading("loading1");

  const username = document.getElementById("username").value.trim().toUpperCase();
  const password = document.getElementById("password").value.trim();
  const ceu = document.getElementById("ceu").value.trim();

  const match = userData.find(u => 
    u.username.toUpperCase() === username &&
    u.password === password &&
    String(u.ceu) === ceu
  );

  document.getElementById("loading1").style.display = "none";

  if (match) {
    currentUser = match;
    toggleSection("loginForm", false);
    toggleSection("infoForm", true);
  } else {
    document.getElementById("errorMsg").innerText = "Invalid credentials.";
  }
}

async function validatePersonal() {
  document.getElementById("errorMsg2").innerText = "";
  await showLoading("loading2");

  const fname = document.getElementById("firstname").value.trim().toUpperCase();
  const lname = document.getElementById("lastname").value.trim().toUpperCase();
  const nat = document.getElementById("nationality").value.trim().toUpperCase();
  const pass = document.getElementById("passport").value.trim();
  const caseNum = document.getElementById("caseNumber").value.trim();

  document.getElementById("loading2").style.display = "none";

  if (
    fname === currentUser.firstname.toUpperCase() &&
    lname === currentUser.lastname.toUpperCase() &&
    nat === currentUser.nationality.toUpperCase() &&
    pass === String(currentUser.passport) &&
    caseNum === String(currentUser.caseNumber)
  ) {
    toggleSection("infoForm", false);
    toggleSection("linksPanel", true);

    // ایجاد دکمه‌های لینک‌ها به صورت داینامیک
    const linksDiv = document.querySelector(".buttons-wrapper");
    linksDiv.innerHTML = ""; // پاک کردن لینک‌های قدیمی

    for (let i = 1; i <= 5; i++) {
      if (currentUser["link" + i]) {
        const btn = document.createElement("button");
        btn.innerText = "Document " + i;
        btn.onclick = () => window.open(currentUser["link" + i], "_blank");
        linksDiv.appendChild(btn);
      }
    }
  } else {
    document.getElementById("errorMsg2").innerText = "Personal info doesn't match.";
  }
}

function toggleSection(id, show) {
  const el = document.getElementById(id);
  if (show) el.classList.add("active");
  else el.classList.remove("active");
}

function logout() {
  toggleSection("linksPanel", false);
  toggleSection("loginForm", true);
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";
  document.getElementById("ceu").value = "";
}
</script>
